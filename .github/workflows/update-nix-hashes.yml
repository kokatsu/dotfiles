name: Update Nix Hashes

on:
  pull_request:
    paths:
      - nix/overlays/default.nix

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: read

jobs:
  update-hashes:
    name: Update hashes for Renovate PR
    # Only run for Renovate PRs
    if: github.actor == 'renovate[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      # actions/checkout@v4
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/nix-installer-action@1e3c5df3156622df83bb8f5c467619557d02e284

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '22'

      - name: Detect changed packages
        id: detect
        run: |
          # Get the diff to detect which packages were changed
          git fetch origin main
          DIFF=$(git diff origin/main -- nix/overlays/default.nix)
          OVERLAY="nix/overlays/default.nix"
          PACKAGES=""

          # Check each package independently
          if echo "$DIFF" | grep -q 'termframe'; then
            echo "has_termframe=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*termframe" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_termframe=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }termframe $VERSION"
          fi

          if echo "$DIFF" | grep -q 'deck'; then
            echo "has_deck=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*deck" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_deck=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }deck $VERSION"
          fi

          if echo "$DIFF" | grep -q 'ccusage'; then
            echo "has_ccusage=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*ccusage" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_ccusage=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }ccusage $VERSION"
          fi

          if echo "$DIFF" | grep -q 'agent-browser'; then
            echo "has_agent_browser=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*agent-browser" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_agent_browser=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }agent-browser $VERSION"
          fi

          if echo "$DIFF" | grep -q 'secretlint'; then
            echo "has_secretlint=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*secretlint" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_secretlint=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }secretlint $VERSION"
          fi

          if echo "$DIFF" | grep -q 'cssmodules-language-server'; then
            echo "has_cssmodules_language_server=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*cssmodules-language-server" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_cssmodules_language_server=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }cssmodules-language-server $VERSION"
          fi

          if echo "$DIFF" | grep -q 'unocss-language-server'; then
            echo "has_unocss_language_server=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*unocss-language-server" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_unocss_language_server=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }unocss-language-server $VERSION"
          fi

          if echo "$DIFF" | grep -q 'playwright-cli\|@playwright/cli'; then
            echo "has_playwright_cli=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=@playwright/cli" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_playwright_cli=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }playwright-cli $VERSION"
          fi

          if echo "$DIFF" | grep -q 'marksman'; then
            echo "has_marksman=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*marksman" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_marksman=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }marksman $VERSION"
          fi

          if echo "$DIFF" | grep -q 'keifu'; then
            echo "has_keifu=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*keifu" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_keifu=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }keifu $VERSION"
          fi

          if echo "$DIFF" | grep -q 'octorus'; then
            echo "has_octorus=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*octorus" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_octorus=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }octorus $VERSION"
          fi

          if echo "$DIFF" | grep -q 'x-api-playground'; then
            echo "has_x_api_playground=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=.*playground" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_x_api_playground=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }x-api-playground $VERSION"
          fi

          if echo "$DIFF" | grep -q 'claude-code'; then
            echo "has_claude_code=true" >> $GITHUB_OUTPUT
            VERSION=$(grep -A 20 "# Renovate:.*depName=claude-code" "$OVERLAY" | grep -oP 'version = "\K[^"]+' | head -1)
            echo "version_claude_code=$VERSION" >> $GITHUB_OUTPUT
            PACKAGES="${PACKAGES:+$PACKAGES, }claude-code $VERSION"
          fi

          echo "packages=$PACKAGES" >> $GITHUB_OUTPUT

      # === Pre-built binary packages ===

      - name: Update termframe hashes
        if: steps.detect.outputs.has_termframe == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_termframe }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute hashes for each platform
          for platform in "macos-arm64:aarch64-darwin" "macos-x86_64:x86_64-darwin" \
                          "linux-arm64-gnu:aarch64-linux" "linux-x86_64-gnu:x86_64-linux"; do
            PLAT_NAME="${platform%%:*}"
            NIX_SYSTEM="${platform##*:}"
            URL="https://github.com/pamburus/termframe/releases/download/v${VERSION}/termframe-${PLAT_NAME}.tar.gz"
            HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
            sed -i "/termframe = _final: prev:/,/^  };/{s|\"${NIX_SYSTEM}\" = \"sha256-[^\"]*\"|\"${NIX_SYSTEM}\" = \"${HASH}\"|}" "$OVERLAY"
          done

      - name: Update marksman-binary hashes
        if: steps.detect.outputs.has_marksman == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_marksman }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute hashes for each platform
          for platform in "macos:aarch64-darwin" "macos:x86_64-darwin" \
                          "linux-arm64:aarch64-linux" "linux-x64:x86_64-linux"; do
            PLAT_NAME="${platform%%:*}"
            NIX_SYSTEM="${platform##*:}"
            URL="https://github.com/artempyanykh/marksman/releases/download/${VERSION}/marksman-${PLAT_NAME}"
            HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
            sed -i "/marksman-binary = _final: prev:/,/^  };/{s|\"${NIX_SYSTEM}\" = \"sha256-[^\"]*\"|\"${NIX_SYSTEM}\" = \"${HASH}\"|}" "$OVERLAY"
          done

      - name: Update keifu hashes
        if: steps.detect.outputs.has_keifu == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_keifu }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute hashes for each platform
          for platform in "aarch64-apple-darwin:aarch64-darwin" "x86_64-apple-darwin:x86_64-darwin" \
                          "aarch64-unknown-linux-gnu:aarch64-linux" "x86_64-unknown-linux-gnu:x86_64-linux"; do
            PLAT_NAME="${platform%%:*}"
            NIX_SYSTEM="${platform##*:}"
            URL="https://github.com/trasta298/keifu/releases/download/v${VERSION}/keifu-v${VERSION}-${PLAT_NAME}.tar.gz"
            HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
            sed -i "/keifu = _final: prev:/,/^  };/{s|\"${NIX_SYSTEM}\" = \"sha256-[^\"]*\"|\"${NIX_SYSTEM}\" = \"${HASH}\"|}" "$OVERLAY"
          done

      - name: Update claude-code hashes
        if: steps.detect.outputs.has_claude_code == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_claude_code }}"
          OVERLAY="nix/overlays/default.nix"
          MANIFEST_URL="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/${VERSION}/manifest.json"

          # Get hashes from manifest and convert to SRI format (sha256-...)
          MANIFEST=$(curl -fsSL "$MANIFEST_URL")

          # Function to convert hex hash to SRI format
          hex_to_sri() {
            echo -n "sha256-$(echo "$1" | xxd -r -p | base64 | tr -d '\n')"
          }

          HASH_DARWIN_ARM64=$(hex_to_sri "$(echo "$MANIFEST" | jq -r '.platforms["darwin-arm64"].checksum')")
          HASH_DARWIN_X64=$(hex_to_sri "$(echo "$MANIFEST" | jq -r '.platforms["darwin-x64"].checksum')")
          HASH_LINUX_ARM64=$(hex_to_sri "$(echo "$MANIFEST" | jq -r '.platforms["linux-arm64"].checksum')")
          HASH_LINUX_X64=$(hex_to_sri "$(echo "$MANIFEST" | jq -r '.platforms["linux-x64"].checksum')")

          # Update claude-code section only
          sed -i '/# Claude Code - agentic coding tool/,/^  };$/{
            s|"aarch64-darwin" = "sha256-[^"]*"|"aarch64-darwin" = "'"${HASH_DARWIN_ARM64}"'"|
            s|"x86_64-darwin" = "sha256-[^"]*"|"x86_64-darwin" = "'"${HASH_DARWIN_X64}"'"|
            s|"aarch64-linux" = "sha256-[^"]*"|"aarch64-linux" = "'"${HASH_LINUX_ARM64}"'"|
            s|"x86_64-linux" = "sha256-[^"]*"|"x86_64-linux" = "'"${HASH_LINUX_X64}"'"|
          }' "$OVERLAY"

      - name: Update deck hashes
        if: steps.detect.outputs.has_deck == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_deck }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute hashes for each platform
          for platform in "darwin_arm64.zip:aarch64-darwin" "darwin_amd64.zip:x86_64-darwin" \
                          "linux_arm64.tar.gz:aarch64-linux" "linux_amd64.tar.gz:x86_64-linux"; do
            PLAT_NAME="${platform%%:*}"
            NIX_SYSTEM="${platform##*:}"
            URL="https://github.com/k1LoW/deck/releases/download/v${VERSION}/deck_v${VERSION}_${PLAT_NAME}"
            HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
            sed -i "/deck = _final: prev:/,/^  };/{s|\"${NIX_SYSTEM}\" = \"sha256-[^\"]*\"|\"${NIX_SYSTEM}\" = \"${HASH}\"|}" "$OVERLAY"
          done

      - name: Update ccusage hash
        if: steps.detect.outputs.has_ccusage == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_ccusage }}"
          OVERLAY="nix/overlays/default.nix"

          URL="https://registry.npmjs.org/ccusage/-/ccusage-${VERSION}.tgz"
          HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
          # Update the hash in ccusage section
          sed -i "/ccusage = _final: prev: {/,/^  };/{s|hash = \"sha256-[^\"]*\"|hash = \"${HASH}\"|}" "$OVERLAY"

      - name: Update agent-browser hashes
        if: steps.detect.outputs.has_agent_browser == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_agent_browser }}"
          OVERLAY="nix/overlays/default.nix"
          LOCK_DIR="nix/npm-locks/agent-browser"

          # Update tarball hash
          URL="https://registry.npmjs.org/agent-browser/-/agent-browser-${VERSION}.tgz"
          TARBALL_HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
          sed -i "/agent-browser = _final: prev: let/,/^  };/{s|hash = \"sha256-[^\"]*\";|hash = \"${TARBALL_HASH}\";|}" "$OVERLAY"

          # Regenerate package-lock.json
          mkdir -p /tmp/agent-browser-pkg
          curl -fsSL "$URL" | tar -xzf - -C /tmp/agent-browser-pkg --strip-components=1
          cd /tmp/agent-browser-pkg
          npm install --package-lock-only --ignore-scripts
          cp package-lock.json "$GITHUB_WORKSPACE/$LOCK_DIR/"
          cd "$GITHUB_WORKSPACE"

          # Compute npmDepsHash using prefetch-npm-deps
          NPM_HASH=$(nix run nixpkgs#prefetch-npm-deps -- "$LOCK_DIR/package-lock.json" 2>/dev/null)
          sed -i "/agent-browser = _final: prev: let/,/^  };/{s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${NPM_HASH}\"|}" "$OVERLAY"

      # === NPM packages with buildNpmPackage ===

      - name: Update secretlint hashes
        if: steps.detect.outputs.has_secretlint == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_secretlint }}"
          OVERLAY="nix/overlays/default.nix"
          LOCK_DIR="nix/npm-locks/secretlint"

          # Update version in custom package.json (secretlint-with-preset)
          # This package.json bundles secretlint with rule preset
          cd "$LOCK_DIR"
          sed -i "s|\"version\": \"[^\"]*\"|\"version\": \"${VERSION}\"|" package.json
          sed -i "s|\"secretlint\": \"[^\"]*\"|\"secretlint\": \"${VERSION}\"|" package.json
          sed -i "s|\"@secretlint/secretlint-rule-preset-recommend\": \"[^\"]*\"|\"@secretlint/secretlint-rule-preset-recommend\": \"${VERSION}\"|" package.json

          # Regenerate package-lock.json from custom package.json
          rm -f package-lock.json
          npm install --package-lock-only --ignore-scripts
          cd "$GITHUB_WORKSPACE"

          # Compute npmDepsHash using prefetch-npm-deps
          NPM_HASH=$(nix run nixpkgs#prefetch-npm-deps -- "$LOCK_DIR/package-lock.json" 2>/dev/null)
          sed -i "/secretlint = _final: prev: let/,/^  };/{s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${NPM_HASH}\"|}" "$OVERLAY"

      - name: Update playwright-cli hashes
        if: steps.detect.outputs.has_playwright_cli == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_playwright_cli }}"
          OVERLAY="nix/overlays/default.nix"
          LOCK_DIR="nix/npm-locks/playwright-cli"

          # Update version in custom package.json (playwright-cli-wrapper)
          # This package.json bundles @playwright/cli
          cd "$LOCK_DIR"
          sed -i "s|\"version\": \"[^\"]*\"|\"version\": \"${VERSION}\"|" package.json
          sed -i "s|\"@playwright/cli\": \"[^\"]*\"|\"@playwright/cli\": \"${VERSION}\"|" package.json

          # Regenerate package-lock.json from custom package.json
          rm -f package-lock.json
          npm install --package-lock-only --ignore-scripts
          cd "$GITHUB_WORKSPACE"

          # Compute npmDepsHash using prefetch-npm-deps
          NPM_HASH=$(nix run nixpkgs#prefetch-npm-deps -- "$LOCK_DIR/package-lock.json" 2>/dev/null)
          sed -i "/playwright-cli = _final: prev: let/,/^  };/{s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${NPM_HASH}\"|}" "$OVERLAY"

      - name: Update unocss-language-server hashes
        if: steps.detect.outputs.has_unocss_language_server == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_unocss_language_server }}"
          OVERLAY="nix/overlays/default.nix"
          LOCK_DIR="nix/npm-locks/unocss-language-server"

          # Update tarball hash
          URL="https://registry.npmjs.org/unocss-language-server/-/unocss-language-server-${VERSION}.tgz"
          TARBALL_HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
          sed -i "/unocss-language-server = _final: prev: let/,/^  };/{s|hash = \"sha256-[^\"]*\";|hash = \"${TARBALL_HASH}\";|}" "$OVERLAY"

          # Regenerate package-lock.json
          mkdir -p /tmp/unocss-ls-pkg
          curl -fsSL "$URL" | tar -xzf - -C /tmp/unocss-ls-pkg --strip-components=1
          cd /tmp/unocss-ls-pkg
          npm install --package-lock-only --ignore-scripts
          cp package-lock.json "$GITHUB_WORKSPACE/$LOCK_DIR/"
          cd "$GITHUB_WORKSPACE"

          # Compute npmDepsHash using prefetch-npm-deps
          NPM_HASH=$(nix run nixpkgs#prefetch-npm-deps -- "$LOCK_DIR/package-lock.json" 2>/dev/null)
          sed -i "/unocss-language-server = _final: prev: let/,/^  };/{s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${NPM_HASH}\"|}" "$OVERLAY"

      - name: Update cssmodules-language-server hashes
        if: steps.detect.outputs.has_cssmodules_language_server == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_cssmodules_language_server }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute GitHub source hash
          SRC_HASH=$(nix-prefetch-url --unpack --type sha256 \
            "https://github.com/antonk52/cssmodules-language-server/archive/refs/tags/v${VERSION}.tar.gz" 2>/dev/null | \
            xargs nix hash convert --hash-algo sha256 --to sri)
          sed -i "/cssmodules-language-server = _final: prev: {/,/^  };/{s|hash = \"sha256-[^\"]*\";|hash = \"${SRC_HASH}\";|}" "$OVERLAY"

          # Clone and compute npmDepsHash
          git clone --depth 1 --branch "v${VERSION}" \
            https://github.com/antonk52/cssmodules-language-server.git /tmp/cssmodules-ls
          cd /tmp/cssmodules-ls
          npm install --package-lock-only --ignore-scripts
          NPM_HASH=$(nix run nixpkgs#prefetch-npm-deps -- package-lock.json 2>/dev/null)
          cd "$GITHUB_WORKSPACE"
          sed -i "/cssmodules-language-server = _final: prev: {/,/^  };/{s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${NPM_HASH}\"|}" "$OVERLAY"

      # === Source-built packages ===

      - name: Update octorus hashes
        if: steps.detect.outputs.has_octorus == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_octorus }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute GitHub source hash
          SRC_HASH=$(nix-prefetch-url --unpack --type sha256 \
            "https://github.com/ushironoko/octorus/archive/refs/tags/v${VERSION}.tar.gz" 2>/dev/null | \
            xargs nix hash convert --hash-algo sha256 --to sri)
          sed -i "/octorus = _final: prev: {/,/^  };/{s|hash = \"sha256-[^\"]*\";|hash = \"${SRC_HASH}\";|}" "$OVERLAY"

          # Compute cargoHash using FOD trick
          FAKE_HASH="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
          sed -i "/octorus = _final: prev: {/,/^  };/{s|cargoHash = \"sha256-[^\"]*\";|cargoHash = \"${FAKE_HASH}\";|}" "$OVERLAY"
          CARGO_HASH=$(nix build --no-link --impure --expr '
            let pkgs = import (builtins.getFlake "nixpkgs") {
              system = "x86_64-linux";
              overlays = [ (import ./nix/overlays/default.nix).octorus ];
            };
            in pkgs.octorus
          ' 2>&1 | grep -oP "got:\s+\Ksha256-\S+" | head -1)
          if [ -n "$CARGO_HASH" ]; then
            sed -i "/octorus = _final: prev: {/,/^  };/{s|cargoHash = \"sha256-[^\"]*\";|cargoHash = \"${CARGO_HASH}\";|}" "$OVERLAY"
          else
            echo "::error::Failed to compute cargoHash for octorus"
            exit 1
          fi

      - name: Update x-api-playground hashes
        if: steps.detect.outputs.has_x_api_playground == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.version_x_api_playground }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute GitHub source hash
          SRC_HASH=$(nix-prefetch-url --unpack --type sha256 \
            "https://github.com/xdevplatform/playground/archive/refs/tags/v${VERSION}.tar.gz" 2>/dev/null | \
            xargs nix hash convert --hash-algo sha256 --to sri)
          sed -i "/x-api-playground = _final: prev: {/,/^  };/{s|hash = \"sha256-[^\"]*\";|hash = \"${SRC_HASH}\";|}" "$OVERLAY"

          # Compute vendorHash using FOD trick
          FAKE_HASH="sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
          sed -i "/x-api-playground = _final: prev: {/,/^  };/{s|vendorHash = \"sha256-[^\"]*\";|vendorHash = \"${FAKE_HASH}\";|}" "$OVERLAY"
          VENDOR_HASH=$(nix build --no-link --impure --expr '
            let pkgs = import (builtins.getFlake "nixpkgs") {
              system = "x86_64-linux";
              overlays = [ (import ./nix/overlays/default.nix).x-api-playground ];
            };
            in pkgs.x-api-playground
          ' 2>&1 | grep -oP "got:\s+\Ksha256-\S+" | head -1)
          if [ -n "$VENDOR_HASH" ]; then
            sed -i "/x-api-playground = _final: prev: {/,/^  };/{s|vendorHash = \"sha256-[^\"]*\";|vendorHash = \"${VENDOR_HASH}\";|}" "$OVERLAY"
          else
            echo "::error::Failed to compute vendorHash for x-api-playground"
            exit 1
          fi

      - name: Format code
        run: nix fmt -- .

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add -A
            git commit -m "fix: update nix hashes for ${{ steps.detect.outputs.packages }}"
            git push
          fi

  run-check:
    name: Run Check workflow
    needs: update-hashes
    if: github.actor == 'renovate[bot]'
    uses: ./.github/workflows/check.yml
    secrets:
      CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
