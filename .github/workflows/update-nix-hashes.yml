name: Update Nix Hashes

on:
  pull_request:
    paths:
      - nix/overlays/default.nix

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: read

jobs:
  update-hashes:
    name: Update hashes for Renovate PR
    # Only run for Renovate PRs
    if: github.actor == 'renovate[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      # actions/checkout@v4
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/nix-installer-action@1e3c5df3156622df83bb8f5c467619557d02e284

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: '22'

      - name: Detect changed package
        id: detect
        run: |
          # Get the diff to detect which package was changed
          git fetch origin main
          DIFF=$(git diff origin/main -- nix/overlays/default.nix)

          # Detect package by looking for version changes
          if echo "$DIFF" | grep -q 'termframe'; then
            echo "package=termframe" >> $GITHUB_OUTPUT
          elif echo "$DIFF" | grep -q 'deck'; then
            echo "package=deck" >> $GITHUB_OUTPUT
          elif echo "$DIFF" | grep -q 'ccusage'; then
            echo "package=ccusage" >> $GITHUB_OUTPUT
          elif echo "$DIFF" | grep -q 'agent-browser'; then
            echo "package=agent-browser" >> $GITHUB_OUTPUT
          elif echo "$DIFF" | grep -q 'secretlint'; then
            echo "package=secretlint" >> $GITHUB_OUTPUT
          elif echo "$DIFF" | grep -q 'cssmodules-language-server'; then
            echo "package=cssmodules-language-server" >> $GITHUB_OUTPUT
          elif echo "$DIFF" | grep -q 'unocss-language-server'; then
            echo "package=unocss-language-server" >> $GITHUB_OUTPUT
          else
            echo "package=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Get new version
        id: version
        run: |
          PACKAGE="${{ steps.detect.outputs.package }}"
          OVERLAY="nix/overlays/default.nix"

          case "$PACKAGE" in
            termframe|deck|secretlint|unocss-language-server|agent-browser)
              # Pattern: let version = "x.y.z"
              VERSION=$(grep -A 20 "# Renovate:.*depName=.*${PACKAGE}" "$OVERLAY" | \
                        grep -oP 'version = "\K[^"]+' | head -1)
              ;;
            ccusage|cssmodules-language-server)
              # Pattern: rec { pname = "..."; version = "x.y.z"
              VERSION=$(grep -A 20 "# Renovate:.*depName=.*${PACKAGE}" "$OVERLAY" | \
                        grep -oP 'version = "\K[^"]+' | head -1)
              ;;
            *)
              VERSION=""
              ;;
          esac

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # === Pre-built binary packages ===

      - name: Update termframe hashes
        if: steps.detect.outputs.package == 'termframe'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute hashes for each platform
          for platform in "macos-arm64:aarch64-darwin" "macos-x86_64:x86_64-darwin" \
                          "linux-arm64-gnu:aarch64-linux" "linux-x86_64-gnu:x86_64-linux"; do
            PLAT_NAME="${platform%%:*}"
            NIX_SYSTEM="${platform##*:}"
            URL="https://github.com/pamburus/termframe/releases/download/v${VERSION}/termframe-${PLAT_NAME}.tar.gz"
            HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
            sed -i "s|\"${NIX_SYSTEM}\" = \"sha256-[^\"]*\"|\"${NIX_SYSTEM}\" = \"${HASH}\"|" "$OVERLAY"
          done

      - name: Update deck hashes
        if: steps.detect.outputs.package == 'deck'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute hashes for each platform
          for platform in "darwin_arm64.zip:aarch64-darwin" "darwin_amd64.zip:x86_64-darwin" \
                          "linux_arm64.tar.gz:aarch64-linux" "linux_amd64.tar.gz:x86_64-linux"; do
            PLAT_NAME="${platform%%:*}"
            NIX_SYSTEM="${platform##*:}"
            URL="https://github.com/k1LoW/deck/releases/download/v${VERSION}/deck_v${VERSION}_${PLAT_NAME}"
            HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
            sed -i "s|\"${NIX_SYSTEM}\" = \"sha256-[^\"]*\"|\"${NIX_SYSTEM}\" = \"${HASH}\"|" "$OVERLAY"
          done

      - name: Update ccusage hash
        if: steps.detect.outputs.package == 'ccusage'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OVERLAY="nix/overlays/default.nix"

          URL="https://registry.npmjs.org/ccusage/-/ccusage-${VERSION}.tgz"
          HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
          # Update the hash in ccusage section
          sed -i "/ccusage = _final: prev: {/,/^  };/{s|hash = \"sha256-[^\"]*\"|hash = \"${HASH}\"|}" "$OVERLAY"

      - name: Update agent-browser hash
        if: steps.detect.outputs.package == 'agent-browser'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OVERLAY="nix/overlays/default.nix"

          URL="https://registry.npmjs.org/agent-browser/-/agent-browser-${VERSION}.tgz"
          HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
          # Update the hash in agent-browser section
          sed -i "/agent-browser = _final: prev: let/,/^  };/{s|hash = \"sha256-[^\"]*\"|hash = \"${HASH}\"|}" "$OVERLAY"

      # === NPM packages with buildNpmPackage ===

      - name: Update secretlint hashes
        if: steps.detect.outputs.package == 'secretlint'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OVERLAY="nix/overlays/default.nix"
          LOCK_DIR="nix/npm-locks/secretlint"

          # Update tarball hash
          URL="https://registry.npmjs.org/secretlint/-/secretlint-${VERSION}.tgz"
          TARBALL_HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
          sed -i "/secretlint = _final: prev: let/,/^  };/{s|hash = \"sha256-[^\"]*\";|hash = \"${TARBALL_HASH}\";|}" "$OVERLAY"

          # Regenerate package-lock.json
          mkdir -p /tmp/secretlint-pkg
          curl -fsSL "$URL" | tar -xzf - -C /tmp/secretlint-pkg --strip-components=1
          cd /tmp/secretlint-pkg
          npm install --package-lock-only --ignore-scripts
          cp package-lock.json "$GITHUB_WORKSPACE/$LOCK_DIR/"
          cd "$GITHUB_WORKSPACE"

          # Compute npmDepsHash using prefetch-npm-deps
          NPM_HASH=$(nix run nixpkgs#prefetch-npm-deps -- "$LOCK_DIR/package-lock.json" 2>/dev/null)
          sed -i "/secretlint = _final: prev: let/,/^  };/{s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${NPM_HASH}\"|}" "$OVERLAY"

      - name: Update unocss-language-server hashes
        if: steps.detect.outputs.package == 'unocss-language-server'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OVERLAY="nix/overlays/default.nix"
          LOCK_DIR="nix/npm-locks/unocss-language-server"

          # Update tarball hash
          URL="https://registry.npmjs.org/unocss-language-server/-/unocss-language-server-${VERSION}.tgz"
          TARBALL_HASH=$(nix-prefetch-url --type sha256 "$URL" 2>/dev/null | xargs nix hash convert --hash-algo sha256 --to sri)
          sed -i "/unocss-language-server = _final: prev: let/,/^  };/{s|hash = \"sha256-[^\"]*\";|hash = \"${TARBALL_HASH}\";|}" "$OVERLAY"

          # Regenerate package-lock.json
          mkdir -p /tmp/unocss-ls-pkg
          curl -fsSL "$URL" | tar -xzf - -C /tmp/unocss-ls-pkg --strip-components=1
          cd /tmp/unocss-ls-pkg
          npm install --package-lock-only --ignore-scripts
          cp package-lock.json "$GITHUB_WORKSPACE/$LOCK_DIR/"
          cd "$GITHUB_WORKSPACE"

          # Compute npmDepsHash using prefetch-npm-deps
          NPM_HASH=$(nix run nixpkgs#prefetch-npm-deps -- "$LOCK_DIR/package-lock.json" 2>/dev/null)
          sed -i "/unocss-language-server = _final: prev: let/,/^  };/{s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${NPM_HASH}\"|}" "$OVERLAY"

      - name: Update cssmodules-language-server hashes
        if: steps.detect.outputs.package == 'cssmodules-language-server'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          OVERLAY="nix/overlays/default.nix"

          # Compute GitHub source hash
          SRC_HASH=$(nix-prefetch-url --unpack --type sha256 \
            "https://github.com/antonk52/cssmodules-language-server/archive/refs/tags/v${VERSION}.tar.gz" 2>/dev/null | \
            xargs nix hash convert --hash-algo sha256 --to sri)
          sed -i "/cssmodules-language-server = _final: prev: {/,/^  };/{s|hash = \"sha256-[^\"]*\";|hash = \"${SRC_HASH}\";|}" "$OVERLAY"

          # Clone and compute npmDepsHash
          git clone --depth 1 --branch "v${VERSION}" \
            https://github.com/antonk52/cssmodules-language-server.git /tmp/cssmodules-ls
          cd /tmp/cssmodules-ls
          npm install --package-lock-only --ignore-scripts
          NPM_HASH=$(nix run nixpkgs#prefetch-npm-deps -- package-lock.json 2>/dev/null)
          cd "$GITHUB_WORKSPACE"
          sed -i "/cssmodules-language-server = _final: prev: {/,/^  };/{s|npmDepsHash = \"sha256-[^\"]*\"|npmDepsHash = \"${NPM_HASH}\"|}" "$OVERLAY"

      - name: Format code
        run: nix fmt -- .

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add -A
            git commit -m "fix: update nix hashes for ${{ steps.detect.outputs.package }} ${{ steps.version.outputs.version }}"
            git push
          fi
