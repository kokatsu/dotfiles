name: Update Claude Code

on:
  schedule:
    # 毎日 22:37 UTC (7:37 JST) にチェック
    # 注: 毎時0分は GitHub Actions の高負荷時間帯のため避ける
    - cron: '37 22 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    name: Check and update Claude Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      # actions/checkout@v4
      - uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          persist-credentials: false

      - name: Get current version
        id: current
        run: |
          # Extract version from claude-code section only (not marksman-binary or others)
          version=$(sed -n '/# Claude Code - agentic coding tool/,/^  };$/{ s/.*version = "\([^"]*\)".*/\1/p }' nix/overlays/default.nix | head -1)
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Get latest version
        id: latest
        run: |
          latest=$(curl -fsSL https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/latest)
          echo "version=$latest" >> $GITHUB_OUTPUT

      - name: Check if update needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" = "${{ steps.latest.outputs.version }}" ]; then
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Get manifest and update overlay
        if: steps.check.outputs.needed == 'true'
        run: |
          VERSION="${{ steps.latest.outputs.version }}"
          MANIFEST_URL="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/${VERSION}/manifest.json"

          # Get hashes from manifest and convert to SRI format (sha256-...)
          MANIFEST=$(curl -fsSL "$MANIFEST_URL")

          # Function to convert hex hash to SRI format
          hex_to_sri() {
            echo -n "sha256-$(echo "$1" | xxd -r -p | base64 | tr -d '\n')="
          }

          HASH_DARWIN_ARM64=$(hex_to_sri "$(echo "$MANIFEST" | jq -r '.platforms["darwin-arm64"].checksum')")
          HASH_DARWIN_X64=$(hex_to_sri "$(echo "$MANIFEST" | jq -r '.platforms["darwin-x64"].checksum')")
          HASH_LINUX_ARM64=$(hex_to_sri "$(echo "$MANIFEST" | jq -r '.platforms["linux-arm64"].checksum')")
          HASH_LINUX_X64=$(hex_to_sri "$(echo "$MANIFEST" | jq -r '.platforms["linux-x64"].checksum')")

          # Update claude-code section only
          # Use pattern-based addressing to target only the claude-code overlay
          sed -i '/# Claude Code - agentic coding tool/,/^  };$/{
            s/version = "[^"]*"/version = "'"${VERSION}"'"/
            s|"aarch64-darwin" = "sha256-[^"]*"|"aarch64-darwin" = "'"${HASH_DARWIN_ARM64}"'"|
            s|"x86_64-darwin" = "sha256-[^"]*"|"x86_64-darwin" = "'"${HASH_DARWIN_X64}"'"|
            s|"aarch64-linux" = "sha256-[^"]*"|"aarch64-linux" = "'"${HASH_LINUX_ARM64}"'"|
            s|"x86_64-linux" = "sha256-[^"]*"|"x86_64-linux" = "'"${HASH_LINUX_X64}"'"|
          }' nix/overlays/default.nix

      - name: Create Pull Request
        if: steps.check.outputs.needed == 'true'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f
        with:
          token: ${{ secrets.PAT }}
          commit-message: "build(deps): update claude-code to ${{ steps.latest.outputs.version }}"
          title: "build(deps): update claude-code to ${{ steps.latest.outputs.version }}"
          body: |
            Updates Claude Code from `${{ steps.current.outputs.version }}` to `${{ steps.latest.outputs.version }}`.

            Release: https://github.com/anthropics/claude-code/releases/tag/v${{ steps.latest.outputs.version }}
          branch: update-claude-code-${{ steps.latest.outputs.version }}
          labels: dependencies
          delete-branch: true
